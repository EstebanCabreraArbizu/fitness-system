{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2 class="h4">
                <i class="fas fa-chart-line me-2"></i>
                Historial de mediciones: {{ meta.tipo_medida }}
            </h2>
            <p class="text-muted">
                Rutina: {{ rutina.titulo }} | 
                Cliente: {{ rutina.cliente.nombres }} {{ rutina.cliente.apellidos }}
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Detalles de la Meta</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tipo:</strong> {{ meta.tipo_medida }}</p>
                    <p><strong>Valor inicial:</strong> {{ meta.medida_inicial }} {{ meta.unidad }}</p>
                    <p><strong>Objetivo:</strong> {{ meta.medida_objetivo }} {{ meta.unidad }}</p>
                    
                    {% if meta.logrado %}
                    <div class="alert alert-success">
                        <i class="fas fa-trophy me-2"></i> 
                        Meta lograda el {{ meta.fecha_logro.strftime('%d/%m/%Y') }}
                    </div>
                    {% else %}
                    <div class="progress">
                        {% set ultima_medida = historial[0].medida if historial else meta.medida_inicial %}
                        {% set progreso = ((ultima_medida - meta.medida_inicial) / (meta.medida_objetivo - meta.medida_inicial) * 100)|round if meta.medida_objetivo != meta.medida_inicial else 0 %}
                        
                        {# Reemplazar min/max con condicionales #}
                        {% if progreso < 0 %}
                            {% set progreso = 0 %}
                        {% endif %}
                        {% if progreso > 100 %}
                            {% set progreso = 100 %}
                        {% endif %}
                        
                        <div class="progress-bar" 
                             role="progressbar" 
                             style="width: {{ progreso }}%;" 
                             aria-valuenow="{{ progreso }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ progreso }}%
                        </div>
                    </div>
                    <p class="text-center mt-2">
                        {% if historial %}
                        Última medida: {{ historial[0].medida }} {{ meta.unidad }}
                        ({{ (historial[0].medida - meta.medida_inicial)|round(1) }} 
                        {{ meta.unidad }} de progreso)
                        {% else %}
                        No hay mediciones todavía
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Agregar nueva medición</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label for="medida" class="form-label">Valor</label>
                            <div class="input-group">
                                <input type="number" step="0.1" class="form-control" id="medida" 
                                       name="medida" required>
                                <span class="input-group-text">{{ meta.unidad }}</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notas" class="form-label">Notas</label>
                            <textarea class="form-control" id="notas" name="notas" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus-circle me-1"></i> Registrar medición
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-7">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Historial de mediciones</h5>
                </div>
                <div class="card-body">
                    {% if historial %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Medida</th>
                                    <th>Cambio</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for medida in historial %}
                                <tr>
                                    <td>{{ medida.fecha.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ medida.medida }} {{ meta.unidad }}</td>
                                    <td>
                                        {% if loop.index < historial|length %}
                                        {% set anterior = historial[loop.index].medida %}
                                        {% set cambio = medida.medida - anterior %}
                                        <span class="badge {% if cambio > 0 %}bg-success{% elif cambio < 0 %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ cambio|round(1) }} {{ meta.unidad }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-primary">Inicial</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ medida.notas }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4">
                        <canvas id="progressChart" width="400" height="200"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay mediciones registradas todavía.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <a href="{{ url_for('meta.lista_metas', rutina_id=rutina.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver a Metas
        </a>
    </div>
</div>

{% if historial %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('progressChart').getContext('2d');
    
    // Invertir el orden para que sea cronológico
    const fechas = [{% for medida in historial|reverse %}'{{ medida.fecha.strftime("%d/%m/%Y") }}',{% endfor %}];
    const valores = [{% for medida in historial|reverse %}{{ medida.medida }},{% endfor %}];
    const objetivo = {{ meta.medida_objetivo }};
    
    const gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
    gradientFill.addColorStop(0, 'rgba(75, 192, 192, 0.6)');
    gradientFill.addColorStop(1, 'rgba(75, 192, 192, 0.1)');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: fechas,
            datasets: [
                {
                    label: 'Progreso',
                    data: valores,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: gradientFill,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Objetivo',
                    data: Array(fechas.length).fill(objetivo),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolución de {{ meta.tipo_medida }}'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' {{ meta.unidad }}';
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: '{{ meta.unidad }}'
                    }
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %} 